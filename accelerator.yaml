accelerator:
  displayName: Microservices supply-chain
  description: Configure the path-to-production of multiple app components (microservices)
  iconUrl: https://raw.githubusercontent.com/dektlong/dekt-images/80bfdbf23040731d16310e286e7d40b57e3b23d5/tanzu.png
  tags:
  - cloud-native-secops

  options:
  
  #supplychain selection
    - name: supplychain
      inputType: select
      label: Supply chain 
      description: Generated configuration for the DevOps supply chain
      required: true
      defaultValue: tap
      choices:
        - value: k8s
          text: DIY with k8s
        - value: tbs
          text: Build Service + CRDs
        - value: cf
          text: Tanzu Application Service manifest
        - value: tap
          text: Tanzu Application Platform supply-chain
 
 # TAP supplychain
    - name: workloadType
      label: Workload type
      description: Select the workload type for this supply chain
      inputType: select
      defaultValue: web
      dependsOn:
        name: supplychain
        value: tap
      choices:
       - value: data-processor 
         text: Data transformer 
       - value: event-topic 
         text: Event topic processor
       - value: ml
         text: ML workload
       - value: web
         text: Web
       - value: web-backend
         text: Web backend
       - value: web-frontend
         text: Web frontend
       
    - name: addTesting
      label: Add pre-prod testing 
      description: Add a pipeline to run pre-prod testing (the pipeline tool was pre-configured for you by the central ops team)
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: supplychain
        value: tap
    - name: testScope
      label: Testing scope
      description: Select scope of testing in your pipeline
      inputType: checkbox
      dataType: [string]
      defaultValue: [ core ]
      dependsOn:
        name: addTesting
        value: true
      choices:
        - value: core
          text: Core functionality
        - value: data
          text: Data integrations
        - value: api
          text: External APIs
        - value: stress
          text: Stress testing
        - value: pen
          text: Pen testing
    - name: scanScope
      label: Scanning scope
      description: Select the scope of your scanning
      inputType: select
      defaultValue: src
      dependsOn:
        name: supplychain
        value: tap
      choices:
       - value: src
         text: Source only
       - value: srcImg
         text: Source and image
    - name: addTesting
      label: Add pre-prod testing 
      description: Add a pipeline to run pre-prod testing (the pipeline tool was pre-configured for you by the central ops team)
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: supplychain
        value: tap
    - name: scaleToZero
      label: Enable scale to zero
      description: Enable cloud native runtimes workloads to scale to zero
      inputType: toggle 
      defaultValue: true
      dataType: boolean
      dependsOn:
        name: supplychain
        value: tap
    #External services configs
    - name: addExternalServices
      label: Enable external services
      description: Enable access to external services
      inputType: toggle 
      defaultValue: false
      dependsOn:
        name: supplychain
        value: tap
      dataType: boolean
    - name: externalDB
      label: External database service
      description: Select an external broker to a database service 
      inputType: select
      defaultValue: PostgreSQLOperator
      dependsOn:
        name: addExternalServices
        value: true
      choices:
        - value: AmazonRDSBroker
          text: Cloud broker to Amazon RDS
        - value: AzureSQLBroker
          text: Cloud broker to Azure SQL
        - value: GoogleSQLBroker
          text: Cloud broker to Google Cloud SQL
        - value: PostgreSQLOperator
          text: PostgreSQL cluster operator
    - name: externalMsg
      label: External messaging service
      description: Select an external broker to a messaging service 
      inputType: select
      defaultValue: RabbitMQOperator
      dependsOn:
        name: addExternalServices
        value: true
      choices:
        - value: AmazonSQSBroker
          text: Cloud broker to Amazon SQS
        - value: AzureServiceBusBroker
          text: Cloud broker to Azure Service Bus
        - value: GoogleSQLBroker
          text: Cloud broker to Google Pub-Sub
        - value: RabbitMQOperator
          text: RabbitMQ cluster operator
    - name: externalStorage
      label: External storage service
      description: Select an external broker to a storage service 
      inputType: select
      defaultValue: CassandraOperator
      dependsOn:
        name: addExternalServices
        value: true
      choices:
        - value: S3Broker
          text: Cloud broker to Amazon S3
        - value: AzureBlobBroker
          text: Cloud broker to Azure Blob
        - value: GoogleStorageBroker
          text: Cloud broker to Google Storage
        - value: CassandraOperator
          text: Cassandra cluster operator
    - name: externalStreaming
      label: External streaming service
      description: Select an external broker to a streaming service 
      inputType: select
      defaultValue: KafkaOperator
      dependsOn:
        name: addExternalServices
        value: true
      choices:
        - value: KinesisBroker
          text: Cloud broker to Amazon Kinesis
        - value: AzureEventHubsBroker
          text: Cloud broker to Azure Event Hubs
        - value: GoogleDataflowBroker
          text: Cloud broker to Google Cloud Dataflow
        - value: KafkaOperator
          text: Kafka cluster operator
        
#workloads repos
    - name: gitRepos
      label: Microservices git repos
      description: A seprate git repo for every app component
      inputType: multi-text
      required: true
      dataType: [string]
      defaultValue:
        - https://github.com/dektlong/dekt4pets-backend
        - https://github.com/dektlong/dekt4pets-frontend
        - https://github.com/dektlong/adopter-check
    
#API-grid configs
    - name: addAPIGrid
      label: Add API-grid 
      description: Setup custom configurations for API Gateway, Portal and access control
      inputType: toggle 
      defaultValue: false
      display: true
      dataType: boolean
   #api-portal  
    - name: portalScope
      inputType: checkbox
      label: API access policies
      description: What api groups will be included in API portal
      dependsOn:
        name: addAPIGrid
        value: true
      dataType: [string]
      defaultValue:
        - dev
      choices:
        - value: dev
          text: "Dev gateways in project's domain (team collaboration)"
        - value: brownfield
          text: "3rd-party & legacy sytems approved for this project"
        - value: public
          text: "Publicly accessible APIs "
    - name: openAPISources
      label: Open api source urls
      inputType: multi-text
      dataType: [string]
      dependsOn:
        name: portalScope
        value: 
          - brownfield
          - public
      defaultValue:
        - scg-openapi.apps.dekt.io/openapi
    - name: forceRateLimit
      label: Rate-limits for all routes
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: portalScope
        value: 
          - brownfield
    - name: forceSSO
      label: SSO for all routes
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: portalScope
        value: 
          - brownfield
          - public
    #api-gateway
    - name: vaultIntegration
      label: Add Vault key-management
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: addAPIGrid
        value: true
    - name: ssoProvider
      label: Identity provider for API SSO
      description: SSO identity provider
      inputType: select 
      defaultValue: workspaceOne
      dependsOn:
        name: addAPIGrid
        value: true
      choices:
        - value: amazon
          text: Amazon
        - value: google
          text: Google
        - value: okta
          text: Okta (Auth0)
        - value: microsoft
          text: Microsoft
        - value: workspaceOne
          text: Workspace ONE
    - name: gwHA
      label: Deploy HA micro-gateway
      description:  Micro-gateways requires HA deployment 
      inputType: toggle
      dataType: boolean
      dependsOn:
        name: addAPIGrid
        value: true
      defaultValue: false
    - name: gwMetrics
      label: API observability
      description:  Add observability options to gatway
      inputType: toggle
      dataType: boolean
      dependsOn:
        name: addAPIGrid
        value: true
      defaultValue: false
    - name: apiScorecards
      description: URL for API Scorecards dashboard
      defaultValue: https://vmware.wavefront.com/u/xNrc03cJ7L?t=vmware
      dependsOn:
        name: gwMetrics
        value: true
    - name: wavefront
      label: Tanzu observability
      description:  Add Tanzu observability configuration to gateway
      inputType: toggle
      dataType: boolean
      defaultValue: true
      dependsOn:
        name: gwMetrics
        value: true
    - name: prometheus
      label: Prometheus service monitor 
      description:  Add Prometheus service monitor configuration to gateway
      inputType: toggle
      dataType: boolean
      defaultValue: false
      dependsOn:
        name: gwMetrics
        value: true
          
 #hidden values
    - name: domain
      label: Domain name
      defaultValue: apps.dekt.io
    - name: registry
      label: Image registry
      defaultValue: harbor.apps.cf.tanzutime.com/dekt-apps
    - name: workloads
      label: Workload names
      inputType: multi-text
      dataType: [string]
      defaultValue:
        - backend
        - frontend
        - adopter-check

engine:
  merge:
    #supplychain
    - includes: [ "supplychain/tap/**" ]
      condition: "#supplychain == 'tap'"
      chain:
        - type: YTT
    - includes: [ "supplychain/k8s/**" ]
      condition: "#supplychain == 'k8s'"
    - includes: [ "supplychain/tbs-kpack/**" ]
      condition: "#supplychain == 'tbs'"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: git1
              with: "#gitRepos[0]"
            - text: git2
              with: "#gitRepos[1]"
            - text: git3
              with: "#gitRepos[2]"
            - text: workload1
              with: "#workloads[0]"
            - text: workload2
              with: "#workloads[1]"
            - text: workload3
              with: "#workloads[2]"
            - text: registry
              with: "#registry"
    - includes: [ "supplychain/cf/**" ]
      condition: "#supplychain == 'cf'"
      chain:
        - type: YTT
    
    #api-grid
    - includes: [ "api-grid/k8s/**" ]
      condition: "#supplychain != 'cf'"
      chain:
        - type: YTT
    - includes: [ "api-grid/cf/*.yaml" ]
      condition: "#supplychain == 'cf'"
      chain:
        - type: YTT
    - includes: [ "api-grid/cf/*.json" ]
      condition: "#supplychain == 'cf'"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: domain
              with: "#domain"
