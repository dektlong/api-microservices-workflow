accelerator:
  displayName: API Driven Microservices workflow
  description: Configure the path-to-production of an API-driven microservices application
  iconUrl: https://raw.githubusercontent.com/dektlong/dekt-images/80bfdbf23040731d16310e286e7d40b57e3b23d5/tanzu.png
  tags:
  - onlinestore-devops

  options:
  
  #devops supply chain
    - name: supplychain
      inputType: select
      label: Supply chain 
      description: Generated configuration for the DevOps supply chain
      required: true
      defaultValue: k8s
      choices:
        - value: k8s
          text: DIY with k8s resources
        - value: tbs
          text: Build Service + kNative + kustomize
        - value: cf
          text: Cloud Foundry
        - value: tap
          text: Tanzu Application Platform
 # TAP supplychain specific options
    - name: addTesting
      label: Add pre-prod testing 
      description: Add a pipeline to run pre-prod testing (the pipeline tool was pre-configured for you by the central ops team)
      inputType: toggle 
      defaultValue: false
      dataType: boolean
      dependsOn:
        name: supplychain
        value: tap
    - name: apiTestingScope
      label: API pre-prod testing scope 
      description: Select how your pipeline will control the api lifecycle 
      inputType: checkbox
      dataType: [string]
      defaultValue: [ routes ]
      dependsOn:
        name: addTesting
        value: true
      choices:
        - value: routes
          text: Routes
        - value: mappings
          text: Mappings
        - value: gateways
          text: Gateways
    - name: scanScope
      label: Scanning scope
      description: Select the scope of your scanning
      inputType: select
      defaultValue: src
      dependsOn:
        name: supplychain
        value: tap
      choices:
       - value: src
         text: Source only
       - value: srcImg
         text: Source and image

    #api-portal  
    - name: portalScope
      inputType: checkbox
      label: API-groups scope
      description: What api groups will be included in API portal
      required: true
      dataType: [string]
      defaultValue:
        - dev
      choices:
        - value: dev
          text: "Single gateway (local dev)"
        - value: team
          text: "All gateways in project's domain (team collaboration)"
        - value: brownfield
          text: "3rd -praty & legacy sytems approved for this project"
        - value: publicAuth
          text: "Public APIs that requires a key"
        - value: public
          text: "Public APIs open to all"
    - name: brownfieldSources
      label: Brownfield open API source urls
      inputType: multi-text
      dataType: [string]
      dependsOn:
        name: portalScope
        value: brownfield
      defaultValue:
        - https://brownfield.example.com/openapi
    - name: publicAuthSources
      label: Public Auth open API source urls
      inputType: multi-text
      dataType: [string]
      dependsOn:
        name: portalScope
        value: publicAuth
      defaultValue:
        - https://public-auth.example.com/openapi
    - name: publicSources
      label: Public open API source urls
      inputType: multi-text
      dataType: [string]
      dependsOn:
        name: portalScope
        value: public
      defaultValue:
        - https://public.example.com/openapi
    
    #api gateway
    - name: ssoProvider
      label: Identity provider
      description: SSO identity provider
      inputType: select 
      defaultValue: workspaceOne
      choices:
        - value: amazon
          text: Amazon
        - value: google
          text: Google
        - value: okta
          text: Okta (Auth0)
        - value: microsoft
          text: Microsoft
        - value: workspaceOne
          text: Workspace ONE
    - name: gwHA
      label: Deploy HA micro-gateway
      description:  Micro-gateways requires HA deployment 
      inputType: toggle
      display: true
      defaultValue: false
    - name: gwMetrics
      label: API observability
      description:  Add observability options to gatway
      inputType: toggle
      display: true
      defaultValue: false
    - name: apiScorecards
      description: URL for API Scorecards dashboard
      defaultValue: https://vmware.wavefront.com/u/xNrc03cJ7L?t=vmware
      dependsOn:
        name: gwMetrics
        value: true
    - name: metricsProvider
      description: Metrics provider
      inputType: checkbox
      defaultValue:
        - wavefront
      dependsOn:
        name: gwMetrics
        value: true
      choices:
        - value: wavefront
          text: "Tanzu Observability"
        - value: prometheusServiceMonitor
          text: "Prometheus service monitor"
        - value: prometheusAnnotations
          text: "Prometheus annotations"
    
    #workloads
    - name: gitRepos
      label: Workloads (git repos)
      description: A seprate git repo for every app component
      inputType: multi-text
      required: true
      dataType: [string]
      defaultValue:
        - https://github.com/dektlong/dekt4pets-backend
        - https://github.com/dektlong/dekt4pets-frontend
        - https://github.com/dektlong/adopter-check
    
    #hidden values
    - name: domain
      label: Domain name
      defaultValue: apps.dekt.io
    - name: registry
      label: Image registry
      defaultValue: harbor.apps.cf.tanzutime.com/dekt-apps
      

engine:
  merge:
    #supplychain
    - includes: [ "supplychain/tap/**" ]
      condition: "#supplychain == 'tap'"
      chain:
        - type: YTT
    - includes: [ "supplychain/k8s/**" ]
      condition: "#supplychain == 'k8s'"
    - includes: [ "supplychain/tbs-kpack/**" ]
      condition: "#supplychain == 'tbs'"
      chain:
        - type: YTT
    - includes: [ "supplychain/cf/**" ]
      condition: "#supplychain == 'cf'"
    #api-grid
    - includes: [ "api-grid/api-portal.yaml", "api-grid/gateway.yaml", "api-grid/mapping.yaml" ]
      chain:
        - type: YTT
    - includes: [ "api-grid/policy/project-api-policy.yaml" ]
      condition: "#apiPolicy.contains('project')"
    - includes: [ "api-grid/policy/internal-api-policy.yaml" ]
      condition: "#apiPolicy.contains('internal')"
    - includes: [ "api-grid/policy/external-api-policy.yaml" ]
      condition: "#apiPolicy.contains('external')"
