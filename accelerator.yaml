accelerator:
  displayName: API Driven Microservices workflow
  description: Configure the path-to-production of an API-driven microservices application
  iconUrl: https://raw.githubusercontent.com/dektlong/dekt-images/80bfdbf23040731d16310e286e7d40b57e3b23d5/tanzu.png
  tags:
  - onlinestore-devops

  options:
  
  #devops supply chain
    - name: supplychain
      inputType: select
      label: DevOps supply chain
      description: Generated configuration for the DevOps supply chain
      required: true
      defaultValue: k8s
      choices:
        - value: k8s
          text: DIY with k8s resources
        - value: tbs
          text: Build Service + kustomize
        - value: cf
          text: Cloud Foundry
        - value: tap
          text: Tanzu Application Platform
    
    - name: gitRepos
      label: Microservices git repos
      inputType: multi-text
      required: true
      dataType: [string]
      defaultValue:
        - https://github.com/dektlong/dekt4pets-backend
        - https://github.com/dektlong/dekt4pets-frontend
        
    - name: workloads
      label: Workload names
      inputType: multi-text
      dataType: [string]
      defaultValue:
        - workload1
        - workload2
      
    #API Grid
    - name: apiPolicy
      inputType: checkbox
      label: API policy
      description: Policy to contorl APIs spec and performance
      display: true
      dataType: [string]
      defaultValue:
        - project
        - internal
      choices:
        - value: project
          text: Project: local dev/single team
        - value: internal
          text: Internal: multiple teams/brownfield
        - value: external
          text: Public: external access
  
    #exteral sso provider (if external facing APIs included)    
    - name: ssoProvider
      label: Identity provide
      description: SSO identity provider for external access 
      inputType: select 
      defaultValue: workspaceOne
      dependsOn:
        name: apiValidator
        value: external
      choices:
        - value: amazon
          text: Amazon
        - value: google
          text: Google
        - value: okta
          text: Okta (Auth0)
        - value: microsoft
          text: Microsoft
        - value: workspaceOne
          text: Workspace ONE
    
    - name: haCount
      label: Micro-gateway HA count
      description:  How many instances to deploy every Micro-gateway with 
      required: true
      defaultValue: "2"
      
    - name: apiScorecards
      description: URL for API Scorecards dashboard
      defaultValue: https://vmware.wavefront.com/u/xNrc03cJ7L?t=vmware
      display: true
    
    #hidden values
    - name: domain
      label: Domain name
      defaultValue: tanzu.dekt.io
    - name: registry
      label: Image registry
      defaultValue: harbor.apps.cf.tanzutime.com/dekt-apps
      

engine:
  merge:
    #supplychain transformations
    - includes: [ "supplychain/tap/**" ]
      condition: "#supplychain == 'tap'"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: git1
              with: "#gitRepos[0]"
            - text: git2
              with: "#gitRepos[1]"
            - text: workload1
              with: "#workloads[0]"
            - text: workload2
              with: "#workloads[1]"
    - includes: [ "supplychain/k8s/**" ]
      condition: "#supplychain == 'k8s'"
    - includes: [ "supplychain/tbs-kpack/**" ]
      condition: "#supplychain == 'tbs'"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: git1
              with: "#gitRepos[0]"
            - text: git2
              with: "#gitRepos[1]"
            - text: workload1
              with: "#workloads[0]"
            - text: workload2
              with: "#workloads[1]"
            - text: registry
              with: "#registry"
    - includes: [ "supplychain/cf/**" ]
      condition: "#supplychain == 'cf'"
    #api-grid transformations
    - includes: [ "api-grid/api-portal.yaml", "api-grid/gateway.yaml", "api-grid/mapping.yaml" ]
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: sso-provider
              with: "#ssoProvider"
            - text: ha-count
              with: "#haCount"
            - text: workload1
              with: "#workloads[0]"
            - text: workload2
              with: "#workloads[1]"
            - text: "domain"
              with: "#domain"
    - includes: [ "api-grid/policy/project-api-policy.yaml" ]
      condition: "#apiPolicy.contains('project')"
    - includes: [ "api-grid/policy/internal-api-policy.yaml" ]
      condition: "#apiPolicy.contains('internal')"
    - includes: [ "api-grid/policy/external-api-policy.yaml" ]
      condition: "#apiPolicy.contains('external')"
