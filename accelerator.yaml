accelerator:
  displayName: API Driven Microservices workflow
  description: Configure the path-to-production of an API-driven microservices application
  iconUrl: https://raw.githubusercontent.com/dektlong/dekt-images/80bfdbf23040731d16310e286e7d40b57e3b23d5/tanzu.png
  tags:
  - onlinestore-devops

  options:
  
    #devops supply chain
  
    - name: supplychain
      inputType: checkbox
      label: DevOps supply chain
      description: Generated configuration for the DevOps supply chain
      required: true
      dataType: [string]
      defaultValue:
        - tap
        - tbs
      choices:
        - value: k8s
          text: DIY with k8s resources
        - value: tap
          text: Tanzu Application Platform (kontinue)
        - value: tbs
          text: Build Service (kpack)
        - value: cf
          text: Cloud Foundry
  
    #API Grid
  
    - name: apiValidator
      inputType: checkbox
      label: API validation policy
      description: Policy to score and validate APIs spec and performance
      display: true
      dataType: [string]
      defaultValue:
        - project
        - internal
      choices:
        - value: project
          text: Project level access
        - value: internal
          text: Internal teams collabolartion 
        - value: external
          text: Extenral facing APIs
  
    - name: haCount
      label: Micro-gateway HA count
      description:  How many instances to deploy every Micro-gateway with 
      required: true
      defaultValue: "2"
    
    - name: ssoProvider
      label: Identity provider
      description: SSO OpenID identity provider
      inputType: select 
      defaultValue: openId
      required: true
      choices:
        - value: amazon
          text: Amazon
        - value: google
          text: Google
        - value: okta
          text: Okta (Auth0)
        - value: microsoft
          text: Microsoft
        - value: openId
          text: OpenID connect (generic)
  
    - name: apiScorecards
      description: URL for API Scorecards dashboard
      defaultValue: https://vmware.wavefront.com/u/xNrc03cJ7L?t=vmware
      display: true
    
    #microservices info
    - name: git1
      label: Microservice-1 git 
      description: Git repo for microservice number one
      defaultValue: https://github.com/dektlong/dekt4pets-backend
      required: true
    - name: git2
      label: Microservice-2 git 
      description: Git repo for microservice number two
      defaultValue: https://github.com/dektlong/dekt4pets-frontend
    - name: git3
      label: Microservice-3 git 
      description: Git repo for microservice number three
      defaultValue: https://github.com/dektlong/git3
    - name: git4
      label: Microservice-4 git 
      description: Git repo for microservice number four
      defaultValue: https://github.com/dektlong/git4
    - name: git5
      label: Microservice-5 git 
      description: Git repo for microservice number five
      defaultValue: https://github.com/dektlong/git5
    
    - name: domain
      defaultValue: tanzu.dekt.io
    - name: workload1
      defaultValue: dekt4pets-backend
    - name: workload2
      defaultValue: dekt4pets-frontend
    - name: gatewayRepo
      defaultValue: https://github.com/dektlong/app-gw-configs
    - name: registry
      defaultValue: harbor.apps.cf.tanzutime.com/dekt-apps
      

engine:
  merge:
    #supplychain transformations
    - includes: [ "supplychain/tap-kontinue/**" ]
      condition: "#supplychain.contains('tap')"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: git1
              with: "#git1"
            - text: git2
              with: "#git2"
            - text: workload1
              with: "#workload1"
            - text: workload2
              with: "#workload2"
            - text: gatewayRepo
              with: "#gatewayRepo"
    - includes: [ "supplychain/k8s/**" ]
      condition: "#supplychain.contains('k8s')"
    - includes: [ "supplychain/tbs-kpack/**" ]
      condition: "#supplychain.contains('tbs')"
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: git1
              with: "#git1"
            - text: git2
              with: "#git2"
            - text: registry
              with: "#registry"
    - includes: [ "supplychain/cf/**" ]
      condition: "#supplychain.contains('cf')"
    #api-grid transformations
    - includes: [ "api-grid/api-portal.yaml", "api-grid/gateway.yaml", "api-grid/mapping.yaml" ]
      chain:
        - type: ReplaceText
          substitutions:
            - text: app-name
              with: "#artifactId"
            - text: sso-provider
              with: "#ssoProvider"
            - text: ha-count
              with: "#haCount"
            - text: workload1
              with: "#workload1"
            - text: workload2
              with: "#workload2"
    - includes: [ "api-grid/validators/project-validator.yaml" ]
      condition: "#apiValidator.contains('project')"
    - includes: [ "api-grid/validators/internal-validator.yaml" ]
      condition: "#apiValidator.contains('internal')"
    - includes: [ "api-grid/validators/external-validator.yaml" ]
      condition: "#apiValidator.contains('external')"