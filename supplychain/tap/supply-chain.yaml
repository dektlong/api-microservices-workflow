#@ load("@ytt:data", "data")
---
apiVersion: carto.run/v1alpha1
kind: ClusterSupplyChain
metadata:
  name: #@ data.values.artifactId
spec:
  selector:
    app.tanzu.vmware.com/workload-type: online-store

  components:

    - name: source-provider
      templateRef:
        kind: ClusterSourceTemplate
        name: source-code

#@ if data.values.addScan and data.values.scanScope == "src":
    - name: source-scanner
      templateRef:
        kind: ClusterSourceTemplate
        name: scanned-source
      sources:
      - component: source-provider
        name: source-code
#@ end
    
    - name: image-builder
      templateRef:
        kind: ClusterImageTemplate
        name: built-image
      sources:
#@ if data.values.addScan:
  #@ if data.values.scanScope == "src":
        - component: source-scanner
          name: scanned-source
  #@ else:
        - component: source-code
          name: source
  #@ end
#@ end
        
          
#@ if data.values.addScan:
  #@ if data.values.scanScope == "img":
    - name: image-scanner
      templateRef:
        kind: ClusterImageTemplate
        name: scanned-image
      images:
        - component: image-builder
          name: built-image
  #@ end
#@ end

#@ if data.values.addTesting:
    - name: pre-prod-tester
      templateRef:
        kind: ClusterSourceTemplate
        name: testing-pipeline
      sources:
  #@ if data.values.addScan:
    #@ if data.values.scanScope == "src":
        - component: source-scanner
          name: scanned-source
    #@ else:
        - component: source-provider
          name: source
    #@ end
  #@ end
#@ end    
    
    - name: app-runner
      templateRef:
        kind: ClusterTemplate
        name: app-deploy
      images:
#@ if data.values.addScan:
  #@ if data.values.scanScope == "img":
        - component: image-scanner
          name: scanned-image
  #@ else:
        - component: image-builder
          name: image
  #@ end
#@ end
          
